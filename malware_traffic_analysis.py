
# Malware Traffic Analysis With Python V1.0.
#
# Copyright (C) 2021  Iven Leni Fernandez
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

import json
import urlvoid
import tableprint
import time

# https://malware-traffic-analysis.net/2020/12/29/index.html
#############
# tshark -2 -R "http.request.method==GET or http.request.method==POST" -r input.pcap -T json >output.json
# tshark -2 -R "ip.addr==X.X.X.X and http.request.method==GET" -r input.pcap -T json >output.json
#############

packet_list = []
packet_dic = {}
with open("output.json") as json_file:
    data_dict = json.load(json_file)

for x in range(0,len(data_dict)):

    if list(data_dict[x]['_source']['layers']['http'])[0] != '_ws.expert':
        request_method = list(data_dict[x]['_source']['layers']['http'])[0]
    else:
        request_method = list(data_dict[x]['_source']['layers']['http'])[1]

    packet_dic = {'No':'', 'requests':'', 'src':'', 'dst':'', 'host': '', 'blacklist_status':''}
    packet_dic['No'] = x
    packet_dic['requests'] = data_dict[x]['_source']['layers']['http'][request_method]['http.request.method']
    packet_dic['src'] = data_dict[x]['_source']['layers']['ip']['ip.src']
    packet_dic['dst'] = data_dict[x]['_source']['layers']['ip']['ip.dst']
    packet_dic['host'] = data_dict[x]['_source']['layers']['http']['http.host']
    packet_dic['blacklist_status'] = urlvoid.packet_check(packet_dic['host'])

    packet_list.append(packet_dic)

    time.sleep(0.9)

headers = ['No', 'Requests', 'SRC', 'DST', 'HOST', 'Blacklist Status']

rows =  [a.values() for a in packet_list]

tableprint.banner('Malware Traffic Analysis With Python')
tableprint.table(rows, headers)
